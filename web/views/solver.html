{{
extend 'layout.html'
}}

<meta name="description" content="Solver for the randomized Super Metroid roms"/>
<link rel="shortcut icon" href={{=URL('static','favicon.ico')}} type="image/ico"/>
<script type="text/javascript" src="{{=URL('static', '/highslide/highslide.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "/highslide/highslide.css")}} />
<script type="text/javascript">
hs.graphicsDir = "/solver/static/highslide/graphics/";
hs.showCredits = 0;
hs.zIndexCounter = 1000000;
hs.dimmingOpacity = 0.75;

if (hs.registerOverlay) {
        // The simple semitransparent close button overlay
        hs.registerOverlay({
                thumbnailId: 'areathumb',
                html: '<div class="closebutton"        onclick="return hs.close(this)" title="Close"></div>',
                position: 'top right',
                fade: 2 // fading the semi-transparent overlay looks bad in IE
        });
}
</script>

<link href={{=URL('static', 'css/bootstrap-tour.min.css')}} rel="stylesheet">
<script src="{{=URL('static','js/bootstrap-tour.min.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', 'js/chosen.jquery.min.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "css/chosen.css")}} />

<script type="text/javascript" src="{{=URL('static', 'js/jquery.redirect.js')}}"></script>

<link rel="stylesheet" type="text/css" href="{{=URL('static','image-picker/image-picker.css')}}">
<script src="{{=URL('static', 'image-picker/image-picker.js')}}" type="text/javascript"></script>

<title>Super Metroid VARIA Solver</title>

<style>
{{include 'solver_web/varia.css'}}
.rightStep {
    float: right;
    margin-right: 0.3em;
}
.clickable {
    cursor: pointer;
}
.centerTable {
    margin-left: auto;
    margin-right: auto;
    width: 30%;
}
@media (max-width: 1400px) {
    .centerTable {
        width: 50%;
    }
}
.tdGrey {
    border: 1px solid #ddd;
}
.HL {
    background-color: #F8B000
}
.marginKnows {
    margin-right: 0.5em;
}
.image_picker_image {
    width: 32px;
    image-rendering: -moz-crisp-edges; /* Firefox */
    image-rendering: -o-crisp-edges; /* Opera */
    image-rendering: -webkit-optimize-contrast; /* Webkit (non-standard naming) */
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor; /* IE (non-standard property) */
}
.imageItems {
    width: 16px;
    image-rendering: -moz-crisp-edges; /* Firefox */
    image-rendering: -o-crisp-edges; /* Opera */
    image-rendering: -webkit-optimize-contrast; /* Webkit (non-standard naming) */
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor; /* IE (non-standard property) */
    margin-right: 0.5em;
}
.imageItem {
    width: 32px;
    image-rendering: -moz-crisp-edges; /* Firefox */
    image-rendering: -o-crisp-edges; /* Opera */
    image-rendering: -webkit-optimize-contrast; /* Webkit (non-standard naming) */
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor; /* IE (non-standard property) */
}
.imageBoss {
    width: 64px;
    image-rendering: -moz-crisp-edges; /* Firefox */
    image-rendering: -o-crisp-edges; /* Opera */
    image-rendering: -webkit-optimize-contrast; /* Webkit (non-standard naming) */
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor; /* IE (non-standard property) */
}
.popupRoom {
    position:absolute;
    z-index: 100;
}
.popupRoom img {
    max-width: 30%;
}
.room {
}
.popupArea {
    position:absolute;
    z-index: 100;
}
.popupArea img {
    opacity: 0.75;
}
.area {
}
.popupSubArea {
    position:absolute;
    z-index: 100;
}
.popupSubArea img {
    max-width: 75%;
}
.subarea {
}
.uncollectedItem {
    background-color: #ccc;
}
#spoilerCredits {
    font-family: courier, courier new, serif;
    font-weight: bold;
    background-color: black;
    width: 19em;
    display: none;
    margin: 0 auto;
    margin-top: 1em;
}
#spoilerButton {
    display: none;
}
.spoilerItem {
    color: #e7e700;
    border-bottom: 0px;
    text-align: left;
    padding-top: 0.5em;
}
.spoilerLoc {
    color: #ff8408;
    border-bottom: 0px;
    text-align: left;
}
.spoilerTitle {
    color: #e700e7;
    border-bottom: 0px;
    text-align: center;
}
.spoilerEmpty {
    margin-top: 0.5em;
    border-bottom: 0px;
}
.objective {
    background-color: #1234;
    padding-top: 0.5em;
    padding-bottom: 0.5em;
}
</style>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
// https://stackoverflow.com/questions/16960690/chosen-harvesthq-resize-width-dynamically
$(document).ready(function(){      
   resizeChosen();
   jQuery(window).on('resize', resizeChosen);
});

function resizeChosen() {
   $(".chosen-container").each(function() {
       $(this).attr('style', 'width: 100%');
   });          
}

function guessVARIAPreset(filename) {
  var re = /VARIA_Randomizer_[A]?[D]?[B]?[F]?[M]?[Z]?[S]?X\d+_(\w+)/;
  var match = filename.match(re);
  if(match == null) {
    re = /VARIA_Plandomizer_[A]?[B]?FX\d+_(\w+)/;
    match = filename.match(re);
  }
  if(match != null) {
    var data = match[1];
    console.log(data);

    var re = /^(.*)_([a-zA-Z0-9]+)$/;
    var match = data.match(re);

    console.log(match);

    if(match != null){
      var pS = match[2];
      if(pS == "slowest" || pS == "slow" || pS == "medium" || pS == "fast" || pS == "fastest" || pS == "basic" || pS == "VARIAble" || pS == "speedrun") {
        return match[1];
      } else {
        return match[1] + '_' + match[2];
      }
    } else {
      return data;
    }
  } else {
    return null;
  }
}
function setComplexity() {
{{
  if "complexity" in session.solver:
    response.write("  document.getElementById(\"{}\").click();".format(session.solver["complexity"]), escape=False)
    response.write("  document.getElementById(\"complexity\").value = '{}';".format(session.solver["complexity"]), escape=False)
  else:
    response.write("  document.getElementById(\"simple\").click();", escape=False)
    response.write("  document.getElementById(\"complexity\").value = 'simple';", escape=False)
    pass
}}
}

function changeComplexity(evt, name) {
  if(name == "simple") {
    var show = [];
    var hide = ["forbiddenItemsVisibility"];
    showHide(show, hide);
  } else {
    var show = ["forbiddenItemsVisibility"];
    var hide = [];
    showHide(show, hide);
  }

  // store current complexity
  document.getElementById("complexity").value = name;

  // set current button to active
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  evt.currentTarget.className += " active";
}

function showHide(show, hide) {
  for(var i=0; i<show.length; i++) {
    var showId = show[i];
    var elem = document.getElementById(showId);
    elem.classList.remove("hidden");
  }
  for(var i=0; i<hide.length; i++) {
    var hideId = hide[i];
    var elem = document.getElementById(hideId);
    elem.classList.add("hidden");
  }
}

var previousSelected = [];
function imagePickerClick(obj) {
  var selected = obj.val();
  var lenBefore = previousSelected.length;
  var lenAfter = selected.length;

  if(lenAfter > lenBefore) {
    // a new item as been selected
    var difference = selected.filter(x => !previousSelected.includes(x));
  } else {
    // an item as been unselected
    var difference = previousSelected.filter(x => !selected.includes(x));
  }

  selectItem(difference)

  previousSelected = selected;
}

function selectItem(itemName) {
    items = document.getElementsByClassName(itemName);

    for (i = 0; i < items.length; i++) {
        if(items[i].className.indexOf("HL") != -1){
            items[i].className = items[i].className.replace(" HL", "");
        } else {
            items[i].className += " HL";
        }
    }
}

function doSubmit() {
  if(window.File && window.FileList && window.FileReader) {
    document.getElementById("uploadFile").disabled = true;
  }
  return true;
}

function showPath()
{
  if(document.getElementById('displayPath').checked) {
    document.getElementById('path_div').style.display = "block";
    $("#item").imagepicker({
      clicked: function(option) {imagePickerClick(this);}
    });

  } else {
    document.getElementById('path_div').style.display = "none";
  }
}

{{
if result is not None:
}}

      google.charts.load('current', {'packages':['timeline']});
      google.charts.setOnLoadCallback(drawChart);


      function drawChart() {
        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'Role' });
        dataTable.addColumn({ type: 'string', id: 'Difficulty' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });
        dataTable.addRows([
{{
  if result["diffPercent"] in [20, 40, 60, 80]:
    result["diffPercent"] += 1
    pass

  if result["diffPercent"] <= 20:
    response.write("[ 'Difficulty', 'easy', new Date(1900, 0, 0), new Date({}, 0, 0) ]".format(1900+result["diffPercent"]), escape=False)
  else:
    response.write("[ 'Difficulty', 'easy', new Date(1900, 0, 0), new Date(1920, 0, 0) ],", escape=False)
    pass
  if result["diffPercent"] > 20 and result["diffPercent"] <= 40:
    response.write("[ 'Difficulty', 'medium', new Date(1920, 0, 0), new Date({}, 0, 0) ]\n".format(1900+result["diffPercent"]), escape=False)
  elif result["diffPercent"] > 40:
    response.write("[ 'Difficulty', 'medium', new Date(1920, 0, 0), new Date(1940, 0, 0) ],\n", escape=False)
    pass
  if result["diffPercent"] > 40 and result["diffPercent"] <= 60:
    response.write("[ 'Difficulty', 'hard', new Date(1940, 0, 0), new Date({}, 0, 0) ]\n".format(1900+result["diffPercent"]), escape=False)
  elif result["diffPercent"] > 60:
    response.write("[ 'Difficulty', 'hard', new Date(1940, 0, 0), new Date(1960, 0, 0) ],\n", escape=False)
    pass
  if result["diffPercent"] > 60 and result["diffPercent"] <= 80:
    response.write("[ 'Difficulty', 'very hard', new Date(1960, 0, 0), new Date({}, 0, 0) ]\n".format(1900+result["diffPercent"]), escape=False)
  elif result["diffPercent"] > 80:
    response.write("[ 'Difficulty', 'very hard', new Date(1960, 0, 0), new Date(1980, 0, 0) ],\n", escape=False)
    pass
  if result["diffPercent"] > 80 and result["diffPercent"] < 100:
    response.write("[ 'Difficulty', 'hardcore', new Date(1980, 0, 0), new Date({}, 0, 0) ]\n".format(1900+result["diffPercent"]), escape=False)
  elif result["diffPercent"] == 100:
    response.write("[ 'Difficulty', 'hardcore', new Date(1980, 0, 0), new Date(2000, 0, 0) ],\n", escape=False)
    response.write("[ 'Difficulty', 'mania', new Date(2000, 0, 0), new Date(2010, 0, 0) ]\n", escape=False)
    pass
}}
          ]);

        var options = {
          hAxis: {
            minValue: new Date(1900, 0, 0),
            maxValue: new Date(2020, 0, 0)
          },
          timeline: { groupByRowLabel: true },
          tooltip: { trigger: 'none' },
          colors: ['#6daa53', '#C1B725', '#e69235', '#d13434', '#123456', '#ffffff'],
          avoidOverlappingGridLines: false
        };

function allReady() {
    var e = document.getElementById('timeline');
    // svg elements don't have inner/outerHTML properties, so use the parents
    alert(e.getElementsByTagName('svg')[0].parentNode.innerHTML);
}

    google.visualization.events.addListener(chart, 'ready', function () {
      // remove haxis label
      var labels = container.getElementsByTagName('text');

      for (i = 0; i < labels.length; i++) {
        // console.log(labels[i].textContent)
        var start = labels[i].textContent.substring(0,2);
        if(start == '19' || start == '20') {
          //console.log("found")
          labels[i].parentNode.removeChild(labels[i]);
          i--;
        }
      }

    });
//google.visualization.events.addListener(chart, 'ready', allReady);
        chart.draw(dataTable, options);
}
{{
pass
}}

var timeoutIdRoom;
var timeoutIdSubArea;
window.onload = function(){
    $(".chzn-select").chosen({ width: '100%' });
    resizeChosen();

    setComplexity();

    //Check File API support
    if(window.File && window.FileList && window.FileReader)
    {
        var filesInput = document.getElementById("uploadFile");
        filesInput.addEventListener("change", function(event){
            var files = event.target.files; //It returns a FileList object
            var file = files[0];

            var reader = new FileReader();

            reader.onload = function(e) {
                // check sfc or smc extention
                var re = /(?:\.([^.]+))?$/;
                var ext = re.exec(file.name)[1];
                if( ! (ext === "sfc" || ext === "smc" || ext === "SFC" || ext === "SMC") ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong extension: "+ext);
                    return false;
                }

                var re = /((.*)\.[^.]+)?$/;
                var base = re.exec(file.name)[1];

                var outFileName = file.name.replace(/\.[^/.]+$/, ".json");

                var fileSize = file.size;
                if( fileSize > 4*1024*1024 ) {
                    document.getElementById("uploadFile").value = "";
                    alert("Wrong ROM file size: "+fileSize.toString());
                    return false;
                } else if( fileSize == 3146240) {
                    document.getElementById("uploadFile").value = "";
                    alert("headered ROM detected, please use an unheadered ROM");
                    return false;
                }

                var bytes = new Uint8Array(e.target.result);
                var romData = {};

                // locations items
                var addresses = new Array({{=", ".join(str(address) for address in addresses["locations"])}});
                var arrayLength = addresses.length;
                for(var i=0; i<arrayLength; i++) {
                    romData[addresses[i]] = bytes[addresses[i]];
                    romData[addresses[i]+1] = bytes[addresses[i]+1];
                    romData[addresses[i]+4] = bytes[addresses[i]+4];
                }

                // patches
                var addresses = new Array({{=", ".join(str(address) for address in addresses["patches"])}});
                var arrayLength = addresses.length;
                for(var i=0; i<arrayLength; i++) {
                    romData[addresses[i]] = bytes[addresses[i]];
                }

                // transitions
                var addresses = new Array({{=", ".join(str(address) for address in addresses["transitions"])}});
                var arrayLength = addresses.length;
                for(var i=0; i<arrayLength; i++) {
                    // room ptr
                    romData[addresses[i]] = bytes[addresses[i]];
                    romData[addresses[i]+1] = bytes[addresses[i]+1];
                    // direction
                    romData[addresses[i]+3] = bytes[addresses[i]+3];
                    // screen x y
                    romData[addresses[i]+6] = bytes[addresses[i]+6];
                    romData[addresses[i]+7] = bytes[addresses[i]+7];
                    // distance to spawn
                    romData[addresses[i]+8] = bytes[addresses[i]+8];
                    romData[addresses[i]+9] = bytes[addresses[i]+9];
                    // asmPtr
                    romData[addresses[i]+10] = bytes[addresses[i]+10];
                    romData[addresses[i]+11] = bytes[addresses[i]+11];
                }

                // misc
                var addresses = new Array({{=", ".join(str(address) for address in addresses["misc"])}});
                var arrayLength = addresses.length;
                for(var i=0; i<arrayLength; i++) {
                    romData[addresses[i]] = bytes[addresses[i]];
                }

                // ranges
                var ranges = new Array({{=", ".join(str(range) for range in addresses["ranges"])}});
                var arrayLength = ranges.length;
                for(var i=0; i<arrayLength; i+=2) {
                  low = ranges[i];
                  high = ranges[i+1];
                  for(var j=low; j<=high; j++) {
                    romData[j] = bytes[j];
                  }
                }

                romData["romFileName"] = outFileName;

                var json = JSON.stringify(romData);

                var output = document.getElementById("romJson");
                output.value = json;

                var option = document.createElement('option');
                option.text = option.value = file.name;
                var select = document.getElementById("romFile");
                select.add(option, 0);
                select.value = option.value;

                setGuessedPreset(file.name);

                extractSpoiler(bytes);
            }

            reader.readAsArrayBuffer(file);

        }, false);
    } else {
        alert("This website requires the HTML5 File API, please upgrade your browser to a newer version.");
    }

    $(".room").hover(function(evt) {
        if (!timeoutIdRoom) {
            timeoutIdRoom = window.setTimeout(function() {
                timeoutIdRoom = null;
                var target = $(evt.target);
                var url = window.location.origin+target.data("thumbnail-src");
                $(".popupRoom").html('<img src="'+window.location.origin+target.data('thumbnail-src')+'">');
                $(".popupRoom").css({left: evt.pageX+30, top: evt.pageY});
                getMeta(url, ".popupRoom", setPopupXY);
           }, 500);
        }
    },
    function () {
        if (timeoutIdRoom) {
            window.clearTimeout(timeoutIdRoom);
            timeoutIdRoom = null;
        }
        $(".popupRoom").hide();
    });

    $(".subarea").hover(function(evt) {
        if (!timeoutIdSubArea) {
            timeoutIdSubArea = window.setTimeout(function() {
                timeoutIdSubArea = null;
                var target = $(evt.target);
                var url = window.location.origin+target.data("thumbnail-src");
                $(".popupSubArea").html('<img src="'+url+'">');
                $(".popupSubArea").css({left: evt.pageX+30, top: evt.pageY});
                getMeta(url, ".popupSubArea", setPopupXY);
           }, 500);
        }
    },
    function () {
        if (timeoutIdSubArea) {
            window.clearTimeout(timeoutIdSubArea);
            timeoutIdSubArea = null;
        }
        $(".popupSubArea").hide();
    });
}

function displaySpoiler() {
    var elem = document.getElementById("spoilerCredits");
    var current = elem.style.display;
    if(current == "none" || current == "") {
        elem.style.display = "block";
    } else {
        elem.style.display = "none";
    }
}

function extractSpoiler(data) {
    var isVARIA = false;
    var isRace = false;
    if(data[0x175ca] == 0x60 && data[0x19E1] == 0xEA && data[0xF27] == 0x20) {
        isVARIA = true;
    }
    for(var addr=0x1C0200; addr<0x1C0210; addr++) {
        if(data[addr] != 0xff) {
            isRace = true;
            break;
        }
    }

    // hide spoiler
    document.getElementById("spoilerCredits").style.display = "none";
    if(! isVARIA || isRace) {
        document.getElementById("spoilerButton").style.display = "none";
        return;
    } else {
        document.getElementById("spoilerButton").style.display = "block";
    }

    var spoiler = Array(19*2);
    for(var i=0; i<19; i++) {
        var locStart = 0x2f5240+i*0x80+0x40;
        var itemStart = 0x2f5240+i*0x80;

        var locArray = Array(32);
        var itemArray = Array(32);

        for(var j=0; j<32; j++) {
            //console.log("loc "+j+": "+toChar(data[locStart+j*2]).charCodeAt(0));
            locArray[j] = toChar(data[locStart+j*2]);
            itemArray[j] = toChar(data[itemStart+j*2]);
        }

        var locString = locArray.join("");
        var itemString = itemArray.join("");

        spoiler[i*2+1] = locString;
        spoiler[i*2] = itemString;
    }

    document.getElementById("spoilerCredits").innerHTML = `
<table class="center">
<tr><td class="spoilerTitle">ITEM LOCATIONS</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[0]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[1]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[2]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[3]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[4]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[5]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[6]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[7]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[8]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[9]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[10]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[11]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[12]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[13]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[14]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[15]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[16]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[17]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[18]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[19]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[20]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[21]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[22]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[23]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[24]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[25]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[26]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[27]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[28]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[29]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[30]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[31]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[32]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[33]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[34]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[35]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
<tr><td class="spoilerItem">${spoiler[36]}</td></tr>
<tr><td class="spoilerLoc">${spoiler[37]}</td></tr>
<tr><td class="spoilerEmpty"></td></tr>
</table>
`;
}

function toChar(b) {
    //console.log("byte is: "+b);
    if(b == 0x7f) {
        return ' ';
    } else if(b == 0x1f) {
        return '!';
    } else if(b == 0x1e) {
        return ':'
    } else if(b == 0x1d) {
        return '\\'
    } else if(b == 0x1c) {
        return '_'
    } else if(b == 0x1b) {
        return ','
    } else if(b == 0x1a) {
        return '.'
    } else {
        return String.fromCharCode(b + 0x41)
    }
}

function getMeta(url, popup, callback) {
    var img = new Image();
    img.src = url;
    img.onload = function() { callback(url, popup, this.width, this.height); }
}

function setPopupXY(url, popup, width, height) {
  var top = $(popup).css("top");
  // top is like: 812px, remove last two chars: px
  top = top.slice(0, -2);
  // image is reduced in css
  if(popup == ".popupSubArea") {
    height *= 0.75;
  } else if(popup == ".popupRoom") {
    height *= 0.30;
  }
  // magic number 30 or else the image is too low
  top = parseInt(top, 10) - Math.floor(height/2) - 30;
  if(url.includes("TourianSubArea")) {
    // mother brain loc is at the bottom and the image is clipped
    top -= 100;
  }
  $(popup).css({top: top});
  $(popup).show();
}

function lastRomFileChanged(elem) {
  var romName = elem.options[elem.selectedIndex].text;
  setGuessedPreset(romName);
}

function setGuessedPreset(romName){
  var preset = guessVARIAPreset(romName);
  if(preset != null) {
    document.getElementById("preset").value = preset;
    $("#preset").trigger("chosen:updated");
  }
}

function startTheTour(step=-1) {
  // the tour tutorial
  var tour = new Tour({
    storage: false,
    steps: [
    {
      element: "#uploadFileStep",
      title: "ROM file",
      content: "The randomized ROM that you want to solve."
    },
    {
      element: "#romFileStep",
      title: "Already uploaded ROM files",
      content: "Solve again an already uploaded ROM file."
    },
    {
      element: "#presetStep",
      title: "Preset",
      content: "The preset is used by the Solver to know which techniques are available to reach the items locations.<br/>You can create and manage your preset on the <a href=\"/solver/solver_web/presets\" target=\"_blank\">Presets part of the website</a>.<br/>Load one of the standard presets (sorted in increased difficulty), tournament presets, or you own from the community presets."
    },
    {
      element: "#difficultyTargetStep",
      title: "Difficulty Target",
      content: "The maximum difficulty for picking up an item in the current area before moving to another area.<br/><b>Warning</b>: selecting a too hard difficulty may produce unrealistic results.",
      placement: "auto left"
    },
    {
      element: "#pickupStrategyStep",
      title: "Pickup Strategy",
      content: "Strategy for picking up major and minor items.<br/>\
<ul>\
<li>100%: Will grab all major and minor items.</li>\
<li>Any%: No requirements on the items as long as the seed is finishable.</li>\
</ul>",
      placement: "auto left"
    },
    {
      element: "#spoilerButtonStep",
      title: "Display credits spoiler",
      content: "Extract the spoiler logs from the in-game credits and display it."
    },
    {
      element: "#forbiddenItemsStep",
      title: "Forbidden Items",
      content: "For testing purpose you can choose to not pick up some items."
    } ]});

  // Initialize the tour
  tour.init();

  if (typeof step === "object") {
    // step is an event, not a number. Get ID from parent element
    let parent = event.target.parentNode
    step = parent.id
    while (!step) {
        parent = parent.previousElementSibling
        step = parent.id
    }
  }
  if (typeof step === 'string') {
    step = tour._options.steps.findIndex((tour_step) => tour_step.element === `#${step}`)
  }
  // Start the tour
  if(step != -1) {
    tour.goTo(step);
  }
  tour.start();
}

function DoPost(){
    $.redirect("/presets", { action: "Load", currenttab: "Techniques1", preset: document.getElementById("preset").value }, "POST", "_blank");
}
</script>

{{
  difficulties = {
      easy : 'easy',
      medium : 'medium',
      hard : 'hard',
      harder : 'very hard',
      hardcore : 'hardcore',
      mania : 'mania',
      mania*2: 'god'
  }
}}

<div class="fixed">
  <div class="menu">
    <table class="full menuTable">
      <tr>
        <td>{{=A("Home", _href=URL(f="home"), _class="menu")}}</td>
        <td>{{=A("Presets", _href=URL(f="presets"), _class="menu")}}</td>
        <td>{{=A("Randomizer", _href=URL(f="randomizer"), _class="menu")}}</td>
        <td class="menu_selected">{{=A("Solver", _href=URL(f="solver"), _class="menu")}}</td>
        <td>{{=A("Tracker", _href=URL(f="tracker"), _class="menu")}}</td>
        <td>{{=A("Plandomizer", _href=URL(f="plando"), _class="menu")}}</td>
        <td>{{=A("Plandository", _href=URL(f="plandorepo"), _class="menu")}}</td>
        <td>{{=A("Customizer", _href=URL(f="customizer"), _class="menu")}}</td>
        <td>{{=A("Statistics", _href=URL(f="extStats"), _class="menu")}}</td>
        <td>{{=A("Information & Contact", _href=URL(f="infos"), _class="menu")}}</td>
      </tr>
    </table>
  </div>
</div>

<div class="main">
  <div id="complexityTabs" class="center">
    <div class="tab">
      <button class="tablinks" id="simple" onclick="changeComplexity(event, 'simple');">Simple</button>
      <button class="tablinks" id="advanced" onclick="changeComplexity(event, 'advanced');">Advanced</button>
    </div>
  </div>

  <div id="tabRando" class="tabcontent">
    <p>
      Using the techniques known in the chosen preset check if a ROM can be finish and its estimated difficulty.<br/>
      Choose your randomized ROM to solve, the preset to use then press 'Solve'.
    </p>
    <form id="solverForm" class="presetform" method="post" enctype="multipart/form-data" onsubmit="doSubmit();">
      <div class="row">
        <div class="column">
          <table class="full">
            <colgroup><col class="half" /><col class="half" /></colgroup>
            <tr>
              <td>Randomized Super Metroid ROM: </td>
              <td><input id="uploadFile" name="uploadFile" type="file"/></td>
              <td id="uploadFileStep"><button type="button" onclick="startTheTour(event)">?</button></td>
            </tr>
            <tr>
              <td>Already uploaded ROMs in this session: </td>
              <td>{{=SELECT(*roms, **dict(_name="romFile", _id="romFile", value=lastRomFile, _class="filldropdown", _onchange="lastRomFileChanged(this);"))}}</td>
              <td id="romFileStep"><button type="button" onclick="startTheTour(event)">?</button></td>
            </tr>
            <tr>
              <td>Preset: <span class="rightStep"><a href="javascript:DoPost()">What's in the logic for this skills preset ?</a></td>
              <td>{{=SELECT(OPTGROUP(*stdPresets, **dict(_label="Standard presets")), OPTGROUP(*tourPresets, **dict(_label="Tournament presets")), OPTGROUP(*comPresets, **dict(_label="Community presets")), **dict(_name="preset", _id="preset", value=session.solver["preset"], _class="chzn-select"))}}</td>
              <td id="presetStep"><button type="button" onclick="startTheTour(event)">?</button></td>
            </tr>
          </table>
        </div>
        <div class="column">
          <table class="full">
            <colgroup><col class="half" /><col class="half" /></colgroup>
          <tr>
            <td>Difficulty target:</td>
            <td>{{=SELECT("easy", "medium", "hard", "very hard", "hardcore", "mania", _id="difficultyTarget", _name="difficultyTarget", _class="full", value=difficulties[session.solver["difficultyTarget"]])}}</td>
            <td id="difficultyTargetStep"><button type="button" onclick="startTheTour(event)">?</button></td>
          </tr>
            <tr>
              <td>Pickup strategy:</td>
              <td>
                  <select form="solverForm" class="full" id="pickupStrategy" name="pickupStrategy">
                    <option {{
if session.solver["pickupStrategy"] == "any":
  response.write('selected="selected"', escape=False)
  pass
}} value="any">any%</option>
                    <option {{
if session.solver["pickupStrategy"] == "all":
  response.write('selected="selected"', escape=False)
  pass
}} value="all">100%</option>
                  </select>
              </td>
              <td id="pickupStrategyStep"><button type="button" onclick="startTheTour(event)">?</button></td>
            </tr>
            <tr id="spoilerButton">
              <td><button type="button" onclick="displaySpoiler()">Display credits spoiler</button></td><td></td>
              <td id="spoilerButtonStep"><button type="button" onclick="startTheTour(event)">?</button></td>
            </tr>
          </table>
        </div>
      </div>
      <input id="romJson" name="romJson" style="display:none" type="text"/>

      <div id="forbiddenItemsVisibility">
        <h3>Items not picked up <span id="forbiddenItemsStep"><button type="button" onclick="startTheTour(event)">?</button></span></h3>
        <table class="full">
          <tr>
{{
  i = 0
  for item in ['Bomb', 'Charge', 'ETank', 'Grapple', 'Gravity', 'HiJump', 'Ice', 'Missile', 'Morph', 'Plasma', 'PowerBomb', 'Reserve', 'ScrewAttack', 'SpaceJump', 'Spazer', 'SpeedBooster', 'SpringBall', 'Super', 'Varia', 'Wave', 'XRayScope']:
    if item in session.solver["itemsForbidden"]:
      checked = "checked=\"checked\" value=\"on\""
    else:
      checked = ""
      pass
    response.write("      <td><input id=\"{}_bool\" name=\"{}_bool\" type=\"checkbox\" {}>".format(item, item, checked), escape=False)

    response.write("<img src=\"/solver/static/images/tracker/inventory/{}.png\" alt=\"{}.png\" title=\"{}.png\" class=\"width: 32px\"/>".format(item, item, item), escape=False)
    response.write("</td>\n", escape=False)

    pass
}}
          </tr>
        </table>
      </div>
      <input id="complexity" name="complexity" style="display:none" type="text"/>
      <div>
        <div id="spoilerCredits">
        </div>
      </div>
      {{=INPUT(_type="submit", _value="Solve", _name="action", _class="btn btn-default buttonRandom")}}
    </form>

{{
if result is not None:
}}
    <div class="row">
      <div class="column">
{{
  response.write(result["resultText"]+"<br/>", escape=False)
  pass
}}

{{
if result is not None and result["difficulty"] != -1:
}}
        <div id="timeline" style="height: 3em; width: 100%;"></div>

        <div class="row">
          <div class="column">
            <h4 style="padding-left: 0.5em;">Seed objectives:</h4>
            <ul>
{{
    for objective in result["objectives"]:
      response.write("<li>{}</li>".format(objective), escape=False)
      pass
}}
            </ul>
          </div>
          <div class="column">
            <h4>Tourian:</h4>
            <ul>
              <li>{{=result["tourian"]}}</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="column">
{{
  if result["patches"]:
}}
    <h4>Detected patches:</h4>
    <div class="row">
      <div class="column">
        <ul>
{{
    for i, patch in enumerate(sorted(result["patches"])):
      if i % 2 == 0:
        response.write("<li>{}</li>".format(patch), escape=False)
        pass
      pass
}}
        </ul>
      </div>
      <div class="column">
        <ul>
{{
    for i, patch in enumerate(sorted(result["patches"])):
      if i % 2 == 1:
        response.write("<li>{}</li>".format(patch), escape=False)
        pass
      pass
}}
        </ul>
      </div>
    </div>

    </div>
    </div>
{{
  else:
}}
    </div>
    </div>
{{
    pass
}}
    <p>
      To solve this ROM {{=result["knowsUsed"][0]}} distinct techniques have been used out of the {{=result["knowsUsed"][1]}} known techniques.
    </p>
{{
  if result["itemsOk"] is False:
}}
    <p>
      Warning: the ROM is finishable, but we couldn't pickup all the requested items.
    </p>

{{
    pass
else:
}}
    </div>
    </div>
{{
  pass
}}

{{
if result is not None:
  def setUncollected(item):
    if item not in result["collectedItems"]:
      response.write("data-img-class=\"uncollectedItem\"", escape=False)
      pass
    pass
}}
    <input id="displayPath" name="displayPath" type="checkbox" onClick="showPath()">
    Display the generated path (spoilers)

    <div id="path_div" style="display:none;">
      <div class="popupRoom" style="display:none;">PopupRoom</div>
      <div class="popupArea" style="display:none;">PopupArea</div>
      <div class="popupSubArea" style="display:none;">PopupSubArea</div>
      <br/>
      <p class="centerTable">Click on items to highlight them in the spoiler, grey background items aren't present:</p>

      <div class="centerTable">
      <select multiple="multiple" id="item" name="item">
        <optgroup label="Nothing">
          <option data-img-src="/solver/static/images/tracker/inventory/Nothing.png" value="Nothing">Nothing</option>
        </optgroup>
        <optgroup label="Ammo">
          <option data-img-src="/solver/static/images/tracker/inventory/Missile.png" value="Missile" {{=setUncollected("Missile")}}>Missile</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Super.png" value="Super" {{=setUncollected("Super")}}>Super Missile</option>
          <option data-img-src="/solver/static/images/tracker/inventory/PowerBomb.png" value="PowerBomb" {{=setUncollected("PowerBomb")}}>Power Bomb</option>
        </optgroup>
        <optgroup label="Energy">
          <option data-img-src="/solver/static/images/tracker/inventory/ETank.png" value="ETank" {{=setUncollected("ETank")}}>Energy Tank</option>
            <option data-img-src="/solver/static/images/tracker/inventory/Reserve.png" value="Reserve" {{=setUncollected("Reserve")}}>Reserve Tank</option>
        </optgroup>
        <optgroup label="Beams">
          <option data-img-src="/solver/static/images/tracker/inventory/Charge.png" value="Charge" {{=setUncollected("Charge")}}>Charge Beam</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Ice.png" value="Ice" {{=setUncollected("Ice")}}>Ice Beam</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Wave.png" value="Wave" {{=setUncollected("Wave")}}>Wave Beam</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Spazer.png" value="Spazer" {{=setUncollected("Spazer")}}>Spazer</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Plasma.png" value="Plasma" {{=setUncollected("Plasma")}}>Plasma Beam</option>
        </optgroup>
        <optgroup label="Suits">
          <option data-img-src="/solver/static/images/tracker/inventory/Varia.png" value="Varia" {{=setUncollected("Varia")}}>Varia Suit</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Gravity.png" value="Gravity" {{=setUncollected("Gravity")}}>Gravity Suit</option>
        </optgroup>
        <optgroup label="Items">
          <option data-img-src="/solver/static/images/tracker/inventory/Morph.png" value="Morph" {{=setUncollected("Morph")}}>Morph Ball</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Bomb.png" value="Bomb" {{=setUncollected("Bomb")}}>Bomb</option>
          <option data-img-src="/solver/static/images/tracker/inventory/SpringBall.png" value="SpringBall" {{=setUncollected("SpringBall")}}>Spring Ball</option>
          <option data-img-src="/solver/static/images/tracker/inventory/ScrewAttack.png" value="ScrewAttack" {{=setUncollected("ScrewAttack")}}>Screw Attack</option>
          <option data-img-src="/solver/static/images/tracker/inventory/HiJump.png" value="HiJump" {{=setUncollected("HiJump")}}>Hi-Jump Boots</option>
          <option data-img-src="/solver/static/images/tracker/inventory/SpaceJump.png" value="SpaceJump" {{=setUncollected("SpaceJump")}}>Space Jump</option>
          <option data-img-src="/solver/static/images/tracker/inventory/SpeedBooster.png" value="SpeedBooster" {{=setUncollected("SpeedBooster")}}>Speed Booster</option>
          <option data-img-src="/solver/static/images/tracker/inventory/Grapple.png" value="Grapple" {{=setUncollected("Grapple")}}>Grapple Beam</option>
          <option data-img-src="/solver/static/images/tracker/inventory/XRayScope.png" value="XRayScope" {{=setUncollected("XRayScope")}}>X-Ray Scope</option>
        </optgroup>
      </select>
      </div>
      <br/>
  {{response.write("{}".format(result["pathTable"]), escape=False)}}
{{
  if result["difficulty"] == -1:
}}
      <br/>
      <h4>Next locs which could have been available if more techniques were known</h4>
      {{response.write("{}".format(result["pathremainTry"]), escape=False)}}

{{
    if result["pathremainMajors"] is not None and len(result["pathremainMajors"]) > 0:
}}
      <br/>
      <h4>Remaining major locations</h4>
      {{response.write("{}".format(result["pathremainMajors"]), escape=False)}}
{{
      pass
}}

{{
    if result["pathremainMinors"] is not None and len(result["pathremainMinors"]) > 0:
}}
      <br/>
      <h4>Remaining minor locations</h4>
      {{response.write("{}".format(result["pathremainMinors"]), escape=False)}}
{{
      pass
}}

{{
  else:
    if result["pathskippedMajors"] is not None and len(result["pathskippedMajors"]) > 0:
}}
      <br/>
      <h4>Skipped major locations</h4>
      {{response.write("{}".format(result["pathskippedMajors"]), escape=False)}}
{{
      pass
}}
{{
    if result["pathunavailMajors"] is not None and len(result["pathunavailMajors"]) > 0:
}}
      <br/>
      <h4>Unaccessible major locations</h4>
      {{response.write("{}".format(result["pathunavailMajors"]), escape=False)}}
{{
      pass
}}

{{
    pass
}}

{{
  if result["pngFileName"] is not None and result["pngThumbFileName"] is not None:
}}
      <h4>The graph of the Areas transitions</h4>
      <a href="/solver/static/graph/{{=result["pngFileName"]}}" class="highslide" onclick="return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})"><img id="transitionsthumb" src="/solver/static/graph/{{=result["pngThumbFileName"]}}" alt="Transitions Graph" title="Click to enlarge"/></a>
{{
    pass
}}
      <p>
        Rooms from: <a href="https://wiki.supermetroid.run/">https://wiki.supermetroid.run/</a><br/>
        Area map from: <a href="https://www.snesmaps.com/maps/SuperMetroid/SuperMetroidMapSelect.html">https://www.snesmaps.com/</a><br/>
        Sub Areas map from: <a href="http://www.nordub.ca/Maps/SuperMetroid.png">http://www.nordub.ca/</a>
      </p>
    </div>
{{
  pass
}}
  </div>
</div>
